name: Post Announcements to Slack

on:
  discussion:
    types: [created, edited]

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    steps:
      - name: Check if announcement
        id: check
        run: |
          # Check if the discussion is in the announcements category
          CATEGORY="${{ github.event.discussion.category.slug }}"
          echo "Category: $CATEGORY"
          
          # Check for both possible variations
          if [ "$CATEGORY" = "announcements" ] || [ "$CATEGORY" = "announcement" ]; then
            echo "is_announcement=true" >> $GITHUB_OUTPUT
          else
            echo "is_announcement=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Prepare Slack Message
        if: steps.check.outputs.is_announcement == 'true'
        id: prepare_message
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.discussion.title;
            let body = context.payload.discussion.body;
            const url = context.payload.discussion.html_url;
            
            // Convert GitHub markdown to Slack mrkdwn format
            function convertToSlackFormat(text) {
              // Convert headers (## Header -> *Header*)
              text = text.replace(/^#{1,6}\s+(.+)$/gm, '*$1*');
              
              // Convert code blocks to inline code (```code``` -> `code`)
              text = text.replace(/```[\s\S]*?```/g, (match) => {
                const code = match.replace(/```\w*\n?/g, '').trim();
                return '`' + code + '`';
              });
              
              // Convert HTML breaks to newlines
              text = text.replace(/<br\s*\/?>/gi, '\n');
              
              // Convert markdown links [text](url) to Slack format <url|text>
              text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<$2|$1>');
              
              // Convert tables to bullet points (simple approach)
              text = text.replace(/\|[^\n]+\|/g, (match) => {
                if (match.includes('---|')) return ''; // Skip separator rows
                return match.replace(/\s*\|\s*/g, ' â€¢ ').replace(/^â€¢\s*/, '').replace(/\s*â€¢$/, '');
              });
              
              // Ensure bold text uses Slack format
              text = text.replace(/\*\*([^*]+)\*\*/g, '*$1*');
              
              // Clean up excessive newlines
              text = text.replace(/\n{3,}/g, '\n\n');
              
              return text;
            }
            
            let slackBody = convertToSlackFormat(body);
            
            // Truncate if too long (Slack limit)
            const maxLength = 2500;
            if (slackBody.length > maxLength) {
              slackBody = slackBody.substring(0, maxLength) + '...\n\n_View full announcement on GitHub_';
            }
            
            const payload = {
              text: `New Announcement: ${title}`,
              blocks: [
                {
                  type: "header",
                  text: {
                    type: "plain_text",
                    text: "ðŸ“¢ New Announcement",
                    emoji: true
                  }
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: `*${title}*`
                  }
                },
                {
                  type: "divider"
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: slackBody
                  }
                },
                {
                  type: "divider"
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: `<${url}|View full discussion on GitHub>`
                  }
                }
              ]
            };
            
            // Set the output for the next step
            core.setOutput('slack_payload', JSON.stringify(payload));
            
      - name: Post to Slack
        if: steps.check.outputs.is_announcement == 'true'
        uses: slackapi/slack-github-action@v1
        with:
          payload: ${{ steps.prepare_message.outputs.slack_payload }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DOGRAH_COMMUNITY_WEBHOOK_URL }}
